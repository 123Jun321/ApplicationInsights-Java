# ApplicationInsights-Java Smoke Tests

## Prerequisites
* Windows 10
* [Docker for Windows][windock]

## Overview
The goal for the smoke tests is to exercise and validate the ApplicationInsights Java SDK in each supported environment. The test matrix has dimensions for OS, Application Servers and JREs. A custom task in the gradle build script is used for generating the application environments (using Docker), building the test applications and running the tests against the applications in each environment.

### Directory Structure
All directories are relative to the _smoke test basedir_: `ApplicationInsights-Java/test/smoke/`
* `/testApps`
	* The subdirectories here contain the test application code and the tests against that application. Each directory should be named for the test application. The test application code should generate a WAR file for deployment and the smokeTest code should 
	// TODO link to details about writing test applications and tests

* `/appServers`
	* This contains scripts and Dockerfiles for running the application servers. Each application server should be in a directory named for its app server. The Dockerfile(s) for each environment are parameterized. These are generated by the `.partial.dockerfile` files in each application servers' directory. 
* `/utils`
	* This is a key dependency of the test code under `/testApps`. It contains classes which simplify writing tests.

## Running the Smoke Tests
To run the smoke tests, use the following command:
```
gradle smokeTest
```

This will build the SDK, then build the test environments' docker containers, then build the test applications and their tests; and finally run the tests with the test application deployed to each container.

To see exactly what is being run, try Gradle's "dry run" option: `gradlew -m smokeTest`.

## Execution
The `smokeTest` task performs the following in order:
1. Assembles the SDK
2. Build the test applications (depends on SDK)
3. Generate dockerfiles for application server environments (the `generateDockerfiles` task)
4. Build the docker images from dockerfiles (depends on dockerfile generation; the `buildDockerImages` task)
5. Compile test code
6. Runs the tests

// TODO path to reports

# How to...
## Configure supported JREs for application servers
There are three different files used for determining the supported JREs of an applciation server: the master file, the excludes file, and the includes file.

Each of these files has the same format, one image name per line.

Each line in these files are a reference to a docker image which can be found in the [Docker Hub][dhub]. When the **generateDockerfiles** task is run, a file is generated for each line in this file.

It is recommended for an application server to have either an includes or excludes file, or neither; but not both.

### Specify JREs for all application servers
To add a JRE for all application servers to use, simply add the name of the docker image of the JRE to the master JRE file: `/test/smoke/appServers/jre.master.txt`.

All application servers will generate a dockerfile with these base images unless an excludes file or includes file exists for it.

### Exclude JREs for specific applications servers
If an excludes file exists, e.g. `/test/smoke/appServers/`*`MyAppServer`*`/jre.excludes.txt`, then these will not be used for *MyAppServer*. 

Images in the excludes file which are missing from the master file will have no effect on compilation, but will generate a warning.

### Explicitly specify the JREs for an application server
If an includes file exists, e.g. `/test/smoke/appServers/`*`MyAppServer`*`/jre.includes.txt`, then *only* these will be used for *MyAppServer*.

This file can include JREs which are not found in the master file.

## Add a test application
1. Create a test application directory, e.g. `/test/smoke/testApps/`**_`MyTestApp`_**
2. Create the application's build file: `/test/smoke/testApps/`_`MyTestApp/`**`build.gradle`**_
	* This can be used just like any other build file: add dependencies, add custom build step, add unit tests, etc. See the [gradle documantation][gradledocs] for more information.
	* The application source should be in the standard location: `/test/smoke/testApps/MyTestApp/src/main/java`
	* You will add directories for smoke tests in the next section.
3. Finally, add this project to the root project, e.g. add the following to `ApplciationInsights-Java/settings.gradle`:
	```gradle
	include ':test:smoke:testApps:MyTestApp'
	```

Note: your test application should have a "health check" endpoint at the root. For example, if your application is deployed with the root context `/MyApp` then `/MyApp/` should return a 200 response with a non-empty body when the application is healthy. This is used to determine when the application is successfully deployed. The body content is arbitrary, but must be non-empty.

### Add a test case/class
In the current system, test cases are coupled with the test application. So, you must have created a test application in the previous section to create a test case.

1. Create the smoke test source and resource directories:
	* `/test/smoke/testApps/`_`MyTestApp`_`/src/smokeTest/java`
	* `/test/smoke/testApps/`_`MyTestApp`_`/src/smokeTest/resources`
2. In the smoke test resource directory, create a file `appServers.txt`.
	* You must explicitly specify the shortnames of the application servers where the test application should be deployed; one per line.
	* The application server shortnames can be found in `build.gradle` in their respective directories.
3. Create a smoke test class. This is a JUnit test which inherits from `AiSmokeTest` found in `/utils`.
// TODO metion that junit and utils is already a dependency
4. Specify any additional dependencies using the configuration `smokeTestCompile`, e.g.:
	```gradle
	dependencies {
		smokeTestCompile 'some.org:some.artifact:1.0'
	}
	```

## Add an application server
TODO

## Run a single test or test class
TODO

# Future Plans
* Run smoke tests against provided SDK JARs
* Addional containers for test application dependencies, e.g. backend database.
* Smoke test properties, e.g. configurable port for fake ingestion.
* Start up a application server for manual testing
* Build a docker image to be use as a base image for an application server.
* Decouple tests from test applications (common schema? dynamic resources created by the test?).
* Detect if the smokeTests are being run on a linux machine and only run the Linux tests. Same for Windows.
* Add ability to vary the Linux OS?
* gradles tasks for creating a new test application, new environment; maybe automating other things e.g. 'add jre'

# References
* [Docker for Windows][windock]
* [Docker Hub][dhub]
* [Gradle Documentation][gradledocs]

[windock]: https://www.docker.com/docker-windows
[dhub]: https://hub.docker.com/
[gradledocs]: https://docs.gradle.org/current/userguide/userguide.html
